<!doctype html>

<!--
# Author: Stefan Saam, github@saams.de

#######################################################################
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#######################################################################
-->


<!doctype html>

<!--
# Author: Stefan Saam, github@saams.de

#######################################################################
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#######################################################################
-->


<html lang="" data-theme="dark">

<head>
	
<title>Little Backup Box</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/lbb.css">

<link rel="icon" href="favicon.ico" type="image/x-icon"/>
<link rel="apple-touch-icon" href="img/icons/favicon-180.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="img/icons/favicon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="img/icons/favicon-512.png"/>
	<script type="text/javascript" src="js/logmonitor.js"></script>
	<script type="text/javascript" src="js/display.js"></script>
	<script type="text/javascript" src="js/partition_presets.js"></script>

	<script>
		function HideDisallowedButtons(ActiveSource) {
			let TargetServices = ['usb', 'internal'];

			for (i in TargetServices) {
				let TargetService = TargetServices[i];

// 				find disallowed combinations
				if (
					((TargetService === ActiveSource.value) && (TargetService !== 'usb')) ||
					((ActiveSource.value === 'anyusb') && (TargetService === 'cloud_rsync')) ||
					((ActiveSource.value === 'camera') && (TargetService === 'cloud_rsync')) ||
					((ActiveSource.value === 'ftp') && (TargetService === 'cloud_rsync')) ||
					((ActiveSource.value === 'anyusb') && TargetService.startsWith('social')) ||
					((ActiveSource.value === 'camera') && TargetService.startsWith('social')) ||
					(ActiveSource.value.startsWith('cloud') && TargetService.startsWith('social')) ||
					((ActiveSource.value === 'ftp') && TargetService.startsWith('social'))
				) {
					document.getElementById("Target_" + TargetService).disabled = true;
				} else {
					document.getElementById("Target_" + TargetService).disabled = false;
				}
			}
		}
    </script>
</head>

<body onload="refreshLogMonitor();refreshDisplay();HideDisallowedButtons(document.getElementById('Source_anyusb'))" >
	
<script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
	
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none">
	<symbol id="icon-power" viewBox="0 0 24 24" fill="none">
		<path d="M 17.8 3.0 A 9 9 0 1 1 6.2 3.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
		<line x1="12" y1="1.8" x2="12" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
	</symbol>
</svg>

<nav class="navbar navbar-expand-sm navbar-dark bg-dark">
	<div class="container-fluid">

		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div class="collapse navbar-collapse w-50" id="navbarSupportedContent">
			<ul class="navbar-nav me-auto mb-2 mb-lg-0  w-100">
				<li class="nav-item"><a class="nav-link active" href="index.php.html">Backup</a></li>
				<li class="nav-item"><a class="nav-link" href="sysinfo.php.html">System</a></li>
				<li class="nav-item"><a class="nav-link" href="tools.php.html">Tools</a></li>
				<li class="nav-item"><a class="nav-link" href="view.php.html">View</a></li>
			</ul>
		</div>

		<div class="collapse navbar-collapse w-50" id="navbarSupportedContent">
			<ul class="navbar-nav me-auto mb-2 mb-lg-0  w-100">
				<li class="nav-item"><a class="nav-link" href="frame.php%3Fpage=files.html">Files</a></li>
											<li class="nav-item"><a class="nav-link disabled" href="frame.php%3Fpage=comitup.html">comitup</a></li>
									</ul>
		</div>

		<div class="navbar-collapse collapse" id="navbarSupportedContent">
			<ul class="navbar-nav me-auto mb-2 mb-lg-0">
								<li class="nav-item"><a class="nav-link" href="setup.php.html">Settings</a></li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" href="index.php.html#" id="navbarDropdownPower" role="button" data-bs-toggle="dropdown" aria-expanded="false">
						<svg width="1em" height="1em" style="vertical-align: middle;">
							<use href="#icon-power"/>
						</svg>
					</a>
					<ul class="dropdown-menu" aria-labelledby="navbarDropdownPower">
						<li><a class="dropdown-item" href="http://localhost:8080/index.php?reboot=true">Reboot</a></li>
						<li><a class="dropdown-item" href="http://localhost:8080/index.php?shutdown=true">Power off</a></li>
						<li><a class="dropdown-item" href="http://logout@localhost:8080:80">Logout</a></li>
					</ul>
				</li>
			</ul>
		</div>

	</div>
</nav>

	
	<!-- Suppress form re-submit prompt on refresh -->
	<script>
		if (window.history.replaceState) {
			window.history.replaceState(null, null, window.location.href);
		}
	</script>

		<h1 style="margin-bottom: 1em; letter-spacing: 3px;">LITTLE BACKUP BOX</h1>
	<div style="clear: both;"></div>

	<form class="text-center" style="margin-top: 1em;" method="POST">

		<input type="hidden" name="form_sent" value="1">

		<div class="card">
			<div class="row" style="width:100%; float: left; display: block;">
				<div class="column" style="display: block;">
					<h3>Source</h3>select option<div class='radio-anyusb'><input type='radio' name='SourceDevice' value='anyusb' id='Source_anyusb' onchange='HideDisallowedButtons(this)' checked><label for='Source_anyusb'>any USB</label></br></div><div class='radio-usb'><input type='radio' name='SourceDevice' value='usb' id='Source_usb' onchange='HideDisallowedButtons(this)' ><label for='Source_usb'>USB storage</label></br><input type='radio' name='SourceDevice' value='internal' id='Source_internal' onchange='HideDisallowedButtons(this)' ><label for='Source_internal'>Int. storage</label></br></div><div class='radio-camera'><input type='radio' name='SourceDevice' value='camera' id='Source_camera' onchange='HideDisallowedButtons(this)' ><label for='Source_camera'>Cameras</label></br></div><div class='radio-cloud'><input type='radio' name='SourceDevice' value='ftp' id='Source_ftp' onchange='HideDisallowedButtons(this)' ><label for='Source_ftp'>LBBs FTP server</label></br></div>				</div>
				<div class="column" style="display: block;">
					<h3>Target</h3>execute<div class='backup-buttons'><button class='usb' name='TargetDevice' value='usb' id='Target_usb'>USB</button></br><button class='usb' name='TargetDevice' value='internal' id='Target_internal'>Int. storage</button></br></div><div class='backup-buttons'></div><div class='backup-buttons'></div>				</div>
			</div>

			<div class='backupsection'>
				<button name="stopbackup" class="danger">STOP			</div>
		</div>

		<div class="card" style="margin-top: 3em;">
			<details>

				<summary style="letter-spacing: 1px; text-transform: uppercase;">Modifications</summary>

				<div class='backupsection'>
					<h4>General</h4>
					<table style='border: 0;'>
						<tr>
							<td style='padding-right: 10pt;'>
								<input type="checkbox" id="power_off" name="power_off" >
							</td>
							<td>
								<label for="power_off">Turn off after run</label>
							</td>
						</tr>
					</table>
				</div>

				<div class='backupsection'>
					<h4>Primary backup</h4>
					<table style='border: 0;'>

						<tr>
							<td style='padding-right: 10pt; vertical-align: top;'>
								<input type="checkbox" id="move_files" name="move_files" >
							</td>
							<td>
								<label for="move_files">Move files instead of copying them?</label>
							</td>
						</tr>

						<tr>
							<td style='padding-right: 10pt; vertical-align: top;'>
								<input type="checkbox" id="rename_files" name="rename_files" >
							</td>
							<td>
								<label for="rename_files">Rename files (only for local storage) <a title="Attention! The files should then be deleted from the source. Otherwise they will be transferred again during the next backup, renamed and replacing the version from the previous backup.">&#x1F6C8;</a></label>
							</td>
						</tr>

						<tr>
							<td style='padding-right: 10pt; vertical-align: top;'>
								<input type="checkbox" id="generate_thumbnails" name="generate_thumbnails" checked>
							</td>
							<td>
								<label for="generate_thumbnails">Generate thumbnails and read into database (only for local storage)</label>
							</td>
						</tr>

						<tr>
							<td style='padding-right: 10pt; vertical-align: top;'>
								<input type="checkbox" id="update_exif" name="update_exif" >
							</td>
							<td>
								<label for="update_exif">Write EXIF data to the original files (only for local storage)</label>
							</td>
						</tr>

						<tr>
							<td style='padding-right: 10pt; vertical-align: top;'>
								<input type="checkbox" id="checksum" name="checksum" >
							</td>
							<td>
								<label for="checksum">Compare checksums of files already existing on the target (instead of file size and timestamp)?</label>
							</td>
						</tr>

					</table>

					
					<table style='border: 0;'>

						<tr>
							<td>
								<label for="preset_source">Set source partition:</label>
							</td>
							<td style='padding-right: 10pt;'>
								<select id="preset_source" name="preset_source" onchange="PresetPartitionChange()">
									<option value=''>automatic selection</option>
									<option value='--uuid 67E3-17ED'>sdc1 (uuid 67E3-17ED)</option><option value='--uuid 6752-D0BF'>sdc2 (uuid 6752-D0BF)</option><option value='--uuid 67E3-17ED'>sdd1 (uuid 67E3-17ED)</option>								</select>
							</td>
						</tr>

						<tr>
							<td>
								<label for="preset_target">Set target partition:</label>
							</td>
							<td style='padding-right: 10pt;'>
								<select id="preset_target" name="preset_target" onchange="PresetPartitionChange()">
									<option value=''>automatic selection</option>
									<option value='--uuid 67E3-17ED'>sdc1 (uuid 67E3-17ED)</option><option value='--uuid 6752-D0BF'>sdc2 (uuid 6752-D0BF)</option><option value='--uuid 67E3-17ED'>sdd1 (uuid 67E3-17ED)</option>								</select>
							</td>
						</tr>

					</table>
				</div>

				<div class='backupsection'>
					<h4>Secondary backup</h4>
					<table style='border: 0;'>
						<tr>
							<td style='padding-right: 10pt;'>
								
	<select name="BACKUP_MODE_2" id="BACKUP_MODE_2">
		<option value="none none"  selected>no automatic backup</option>
			</select>

								</td>
							<td>
								<label for="preset_target">Should a cloud backup be performed after the primary backup?</label>
							</td>
						</tr>
					</table>
				</div>

			</details>

			<details>
				<summary style="letter-spacing: 1px; text-transform: uppercase;">View-Database</summary>

				<div class='backupsection'>
					<h3>Generate thumbnails and import them into the database</h3>
					<button name="backup_function" value="thumbnails_usb" class="usb"> &rarr; USB storage</button>
					<button name="backup_function" value="thumbnails_internal" class="usb"> &rarr; int. storage</button>
									</div>

				<div class='backupsection'>
					<h3>Synchronize and clean database</h3>
					<button name="backup_function" value="database_usb" class="usb"> &rarr; USB storage</button>
					<button name="backup_function" value="database_internal" class="usb"> &rarr; int. storage</button>
									</div>

				<div class='backupsection'>
					<h3>Write EXIF data (ratings) into the original files</h3>
					<button name="backup_function" value="exif_usb" class="usb"> &rarr; USB storage</button>
					<button name="backup_function" value="exif_internal" class="usb"> &rarr; int. storage</button>
									</div>
			</details>

			<details>
				<summary style="letter-spacing: 1px; text-transform: uppercase;">File operations</summary>

				<div class='backupsection'>
					<h3>Rename files (only for local storage) <a title="Attention! The files should then be deleted from the source. Otherwise they will be transferred again during the next backup, renamed and replacing the version from the previous backup.">&#x1F6C8;</a></h3>
					<button name="backup_function" value="rename_usb" class="usb"> &rarr; USB storage</button>
					<button name="backup_function" value="rename_internal" class="usb"> &rarr; int. storage</button>
									</div>
			</details>

			<details>
				<summary style="letter-spacing: 1px; text-transform: uppercase;">Telegram</summary>

					<div class='backupsection'>
						<h4>Configure Telegram</h4>
							<!--
# Author: Stefan Saam, github@saams.de

#######################################################################
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#######################################################################
-->

<script>
	async function openChatPicker() {
	const tokenEl								= document.getElementById('conf_SOCIAL_TELEGRAM_TOKEN');
	const conf_SOCIAL_TELEGRAM_CHAT_ID			= document.getElementById('conf_SOCIAL_TELEGRAM_CHAT_ID');
	const conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER	= document.getElementById('conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER');
	const TELEGRAM_CHAT_ID_PRESENTER			= document.getElementById('TELEGRAM_CHAT_ID_PRESENTER');
	const Button_Target_Telegram				= document.getElementById('Target_social:telegram');
	const token   = (tokenEl?.value || '').trim();
	if (!token) { alert('Bitte zuerst den Bot-Token eintragen.'); return; }

	// fetch chats
	const fd = new FormData(); fd.append('token', token);
	const res = await fetch('/telegram_chat_id.php', { method: 'POST', body: fd });
	const data = await res.json();

	if (!data.ok) {
		const errors = {
		'invalid_token': "Invalid token",
		'telegram_unreachable': "Telegram unreachable",
		'bad_api_response': "Bad api response"		};
		alert(errors[data.error] || ('Error: ' + (data.error || 'unknown')));
		return;
	}

	const chats = Array.isArray(data.chats) ? data.chats : [];
	if (chats.length === 0) {
		alert('No chats found. Send a message to the target audience/channel or add the bot as an admin.');
		return;
	}

	// build dialog if not yet
	let dlg = document.getElementById('tg-chat-picker');
	if (!dlg) {
		dlg = document.createElement('dialog');
		dlg.id = 'tg-chat-picker';
		dlg.innerHTML = `
		<form method="dialog" style="min-width:520px; font-family: system-ui, sans-serif;">
			<h3 style="margin:0 0 .5rem 0;">Select chat</h3>
			<p style="margin:.25rem 0 .5rem 0; color:#555;">Display: Name (Type) — <code>chat_id</code></p>
			<select id="tg-chat-select" size="10" style="width:100%;"></select>
			<div style="display:flex; gap:.5rem; margin-top:.75rem; justify-content:flex-end; flex-wrap:wrap;">
			<button id="tg-chat-cancel" value="cancel" type="submit">Close</button>
			<button id="tg-chat-choose" value="default">Accept</button>
			<button id="tg-chat-test" type="button">Send test message</button>
			</div>
			<p id="tg-chat-picked" style="margin:.5rem 0 0 0; color:#555;"></p>
		</form>`;
		document.body.appendChild(dlg);
	}

	// fill options
	const sel = dlg.querySelector('#tg-chat-select');
	sel.innerHTML = '';
	for (const c of chats) {
		const opt = document.createElement('option');
		const id  = String(c.id);
		const t   = c.type || 'unknown';
		const n   = c.name || '(without name)';
		opt.type	= t;
		opt.name	= n;
		opt.value	= id;
		opt.textContent = `${n} (${t}) — ${id}`;
		sel.appendChild(opt);
	}

	const chosenP = dlg.querySelector('#tg-chat-picked');
	dlg.querySelector('#tg-chat-choose').onclick = (e) => {
		e.preventDefault();
		const opt = sel.selectedOptions[0];
		if (!opt) return;
		const name			= opt.name;
		const type			= opt.type;
		const identifier	= name + " (" + type + ")";
		const id			= opt.value;
		if (conf_SOCIAL_TELEGRAM_CHAT_ID) {conf_SOCIAL_TELEGRAM_CHAT_ID.value = id;}
		if (conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER) {conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER.value = identifier;}
		if (Button_Target_Telegram) {
			if (identifier) {
				Button_Target_Telegram.innerHTML = 'Telegram' + '<br /><small style="font-weight: normal;">' + identifier + '</small>';
			} else {
				Button_Target_Telegram.innerHTML = 'Telegram'
			}
		}
		if (TELEGRAM_CHAT_ID_PRESENTER) {TELEGRAM_CHAT_ID_PRESENTER.value = id + ": " + identifier;}
		chosenP.textContent = `Selected: ${id}`;
		dlg.close('ok');
	};

	// test messenger button
	dlg.querySelector('#tg-chat-test').onclick = async () => {
		const opt = sel.selectedOptions[0];
		if (!opt) { alert('Please select a chat first.'); return; }
		const chatId = opt.value;
		try {
		const fd2 = new FormData();
		fd2.append('chat_id', chatId);
		fd2.append('text', 'Test message from Little-Backup-Box via bot');
		const r = await fetch(`https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`, {
			method: 'POST',
			body: fd2
		});
		const res2 = await r.json();
		if (res2.ok) {
			alert('Test message sent to ' + chatId);
		} else {
			alert('Error sending: ' + JSON.stringify(res2));
		}
		} catch (e) {
		alert('Error sending: ' + e);
		}
	};

	if (typeof dlg.showModal === 'function') dlg.showModal();
	else dlg.style.display = 'block';
	}
</script>

<label for="TELEGRAM_CHAT_ID_PRESENTER">Chat ID</label><br />
<input type="hidden" id="conf_SOCIAL_TELEGRAM_CHAT_ID" name="conf_SOCIAL_TELEGRAM_CHAT_ID" value="0">
<input type="hidden" id="conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER" name="conf_SOCIAL_TELEGRAM_CHAT_IDENTIFIER" value="">
<input type="text" id="TELEGRAM_CHAT_ID_PRESENTER" name="TELEGRAM_CHAT_ID_PRESENTER" size="20" value="" disabled>
<br />
<button type="button" onclick="openChatPicker()" id="get_telegram_chat_id">
	Select chat</button>
							<input type="hidden" id="conf_SOCIAL_TELEGRAM_TOKEN" name="conf_SOCIAL_TELEGRAM_TOKEN" value="">
					</div>
			</details>

			<details>
				<summary style="letter-spacing: 1px; text-transform: uppercase;">Matrix</summary>

					<div class='backupsection'>
						<h4>Configure Matrix</h4>
							<!--
# Author: Stefan Saam, github@saams.de

#######################################################################
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#######################################################################
-->

<script>
	async function openMatrixRoomPicker() {
		const homeserverEl							= document.getElementById('conf_SOCIAL_MATRIX_HOMESERVER');
		const tokenEl								= document.getElementById('conf_SOCIAL_MATRIX_TOKEN');
		const conf_SOCIAL_MATRIX_ROOM_ID			= document.getElementById('conf_SOCIAL_MATRIX_ROOM_ID');
		const conf_SOCIAL_MATRIX_ROOM_IDENTIFIER	= document.getElementById('conf_SOCIAL_MATRIX_ROOM_IDENTIFIER');
		const MATRIX_ROOM_ID_PRESENTER				= document.getElementById('MATRIX_ROOM_ID_PRESENTER');
		const Button_Target_Matrix					= document.getElementById('Target_social:matrix');

		const homeserver							= (homeserverEl?.value || '').trim();
		const token									= (tokenEl?.value || '').trim();

		if (!homeserver) { alert('Please enter the Matrix homeserver first.'); return; }
		if (!token)      { alert('Please enter the Matrix access token first.'); return; }

		// Fetch joined rooms via server-side script (to avoid CORS issues with the Matrix homeserver)
		const fd = new FormData();
		fd.append('homeserver', homeserver);
		fd.append('token', token);

		const res  = await fetch('/matrix_rooms.php', { method: 'POST', body: fd });
		const data = await res.json();

		if (!data.ok) {
			const errors = {
				'invalid_token'      : "Invalid access token.",
				'matrix_unreachable' : "Matrix homeserver not reachable.",
				'bad_api_response'   : "Unexpected response from Matrix server."			};
			alert(errors[data.error] || ('Error: ' + (data.error || 'unknown')));
			return;
		}

		const rooms = Array.isArray(data.rooms) ? data.rooms : [];
		if (rooms.length === 0) {
			alert('No rooms found.');
			return;
		}

		// build dialog if not yet present
		let dlg = document.getElementById('mx-room-picker');
		if (!dlg) {
			dlg = document.createElement('dialog');
			dlg.id = 'mx-room-picker';
			dlg.innerHTML = `
			<form method="dialog" style="min-width:520px; font-family: system-ui, sans-serif;">
				<h3 style="margin:0 0 .5rem 0;">Select Matrix room</h3>
				<p style="margin:.25rem 0 .5rem 0; color:#555;">Name — Alias — Room ID</p>
				<select id="mx-room-select" size="10" style="width:100%;"></select>
				<div style="display:flex; gap:.5rem; margin-top:.75rem; justify-content:flex-end; flex-wrap:wrap;">
					<button id="mx-room-cancel" value="cancel" type="submit">Close</button>
					<button id="mx-room-choose" value="default">Apply</button>
					<button id="mx-room-test" type="button">Send test message</button>
				</div>
				<p id="mx-room-picked" style="margin:.5rem 0 0 0; color:#555;"></p>
			</form>`;
			document.body.appendChild(dlg);
		}

		// fill options
		const sel = dlg.querySelector('#mx-room-select');
		sel.innerHTML = '';
		for (const r of rooms) {
			const opt = document.createElement('option');
			const id  = String(r.room_id);
			const name = r.name || r.canonical_alias || '(without name)';
			const alias = r.canonical_alias || '';

			opt.dataset.alias	= alias;
			opt.dataset.name	= name;
			opt.value			= id;
			opt.textContent		= alias ? `${name} — ${alias} — ${id}` : `${name} — ${id}`;

			sel.appendChild(opt);
		}

		const chosenP	= dlg.querySelector('#mx-room-picked');

		// choose room
		dlg.querySelector('#mx-room-choose').onclick	= (e) => {
			e.preventDefault();
			const opt = sel.selectedOptions[0];
			if (!opt) return;

			const name			= opt.dataset.name  || '';
			const alias			= opt.dataset.alias || '';
			const identifier	= alias ? `${name} (${alias})` : name;
			const id			= opt.value;

			if (conf_SOCIAL_MATRIX_ROOM_ID) {conf_SOCIAL_MATRIX_ROOM_ID.value = id;}
			if (conf_SOCIAL_MATRIX_ROOM_IDENTIFIER) {conf_SOCIAL_MATRIX_ROOM_IDENTIFIER.value = identifier;}

			if (Button_Target_Matrix) {
				if (identifier) {
					Button_Target_Matrix.innerHTML	= 'Matrix' + '<br /><small style="font-weight: normal;">' + identifier + '</small>';
				} else {
					Button_Target_Matrix.innerHTML	= 'Matrix';
				}
			}
			if (MATRIX_ROOM_ID_PRESENTER) {
				MATRIX_ROOM_ID_PRESENTER.value = id + ": " + identifier;
			}

			chosenP.textContent	= `Selected: ${id}`;
			dlg.close('ok');
		};

		// test message button
		dlg.querySelector('#mx-room-test').onclick = async () => {
		const opt = sel.selectedOptions[0];
		if (!opt) {
			alert('Please select a room first.');
			return;
		}

		const roomId = opt.value;
		const name   = opt.dataset.name  || '';
		const alias  = opt.dataset.alias || '';

		// Build a nicer label for the alert
		let label = roomId;
		if (name || alias) {
			label = name || alias;
			if (alias && alias !== name) {
				label += ' (' + alias + ')';
			}
		}

		try {
			const fd2 = new FormData();
			fd2.append('homeserver', homeserver);
			fd2.append('token', token);
			fd2.append('room_id', roomId);
			fd2.append('text', 'Matrix test message from Little Backup Box');

			const r    = await fetch('/matrix_send_test.php', {
				method: 'POST',
				body: fd2
			});
			const res2 = await r.json();
			if (res2.ok) {
				alert('Test message sent to ' + label);
			} else {
				alert('Error sending test message: ' + JSON.stringify(res2));
			}
		} catch (e) {
			alert('Error sending test message: ' + e);
		}
	};


		if (typeof dlg.showModal === 'function') dlg.showModal();
		else dlg.style.display = 'block';
	}
	</script>

	<label for="MATRIX_ROOM_ID_PRESENTER">Matrix room ID</label><br />
	<input type="hidden" id="conf_SOCIAL_MATRIX_ROOM_ID" name="conf_SOCIAL_MATRIX_ROOM_ID" value="">
	<input type="hidden" id="conf_SOCIAL_MATRIX_ROOM_IDENTIFIER" name="conf_SOCIAL_MATRIX_ROOM_IDENTIFIER" value="">
	<input type="text" id="MATRIX_ROOM_ID_PRESENTER" name="MATRIX_ROOM_ID_PRESENTER" size="40" value="" disabled>
	<button type="button" onclick="openMatrixRoomPicker()" id="get_matrix_room_id">
		Select room	</button><br />

							<input type="hidden" id="conf_SOCIAL_MATRIX_HOMESERVER" name="conf_SOCIAL_MATRIX_HOMESERVER" value="">
							<input type="hidden" id="conf_SOCIAL_MATRIX_TOKEN" name="conf_SOCIAL_MATRIX_TOKEN" value="">
					</div>
			</details>
		</div>

	</form>

			<div class="card" style="margin-top: 3em;">
			<h2 style="margin-top: 0em;">Log monitor</h2><hr>			<iframe id="logmonitor" src="tmp/little-backup-box.log" width="100%" height="300" style="background: #FFFFFF;" onfocus="clearIntervalLogMonitor()"></iframe>
			<div class="text-center" style="margin-top: 0.5em;">
				<button name="refresh" onclick="refreshLogMonitor()">Refresh</button>
											<a role="button" href="tmp/little-backup-box.log" download="little-backup-box.log"><button>Download</button></a>
							<form action="index.php.html" method="POST">
								<button style="margin-top: 2em;" type="delete" name="delete_logfile" class="danger">Delete log</button>
							</form>
									</div>
		</div>
		
	<div class="card" style="margin-top: 3em;">
		<details>
			<summary style="letter-spacing: 1px; text-transform: uppercase;">Help</summary>
			<p><ul>
   <li>any USB: All connected USB devices, both cameras and storage, are backed up.</li>
   <li>Target rsync server: Cameras cannot be backed up directly to an rsync server. Local caching is required here.</li>
</ul>
<p class = 'text-center'> Please read the <a href='https://github.com/outdoorbits/little-backup-box/wiki/05.-Operation'>Wiki</a>.< /p></p>
		</details>
	</div>

	
<div class="footer">
	<form action="index.php.html" class="text-center" style="margin-top: 1em;" method="POST">
			<div class="card" style="margin-top: 3em;">
				<button type="submit" name="reboot" value="1" class="danger">Reboot</button>
				<button type="submit" name="shutdown" value="1" class="danger">Power off</button>
			</div>
	</form>

</div>

<!-- IP Info -->
<div class="card" style="margin-top: 3em;"><img src="tmp/WIFI.png" style="padding: 5px;" title="HOTSPOT"> <a href="http://10.0.1.40"><img src="tmp/ip-qr-link-10-0-1-40_64_online.png" style="padding: 5px;"></a> 
</div>	</body>

</html>
